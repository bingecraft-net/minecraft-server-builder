#!/usr/bin/env zsh

set -e

if [ -f cidfile ] ; then
  podman start $(cat cidfile)
else
  VELOCITY_VERSION=3.4.0-SNAPSHOT
  VELOCITY_BUILD=515

  IMAGE_TAG=bingecraft-net/velocity-server:$VELOCITY_VERSION-$VELOCITY_BUILD

  podman build \
    --build-arg VELOCITY_VERSION=$VELOCITY_VERSION \
    --build-arg VELOCITY_BUILD=$VELOCITY_BUILD \
    --tag $IMAGE_TAG \
    .

  podman run \
    --cidfile cidfile \
    --detach \
    --interactive \
    --publish 25565:25565 \
    --volume $(readlink -f secrets):/home/minecraft/secrets \
    $IMAGE_TAG
fi

podman logs --follow $(cat cidfile)
